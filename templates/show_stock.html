{% from "macros/jumbotron.html" import jumbotron %}
{% from "macros/popovers.html" import dma_200_diff_popover %}
{% from "macros/stock_attributes.html" import stock_todays_change %}

{% extends "base.html" %}

{% block title %}
  {{ stock.ticker | display }} - {{ stock.name | display }} | RM Stock Tracker
{% endblock %}

{% block style %}
  <link href="{{ url_for('static', filename='styles/show_stock.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
{% if stock.ticker %}
  <!-- Hero Section -->
  {% set heading = stock.ticker ~ " - " ~ (stock.name | display) %}
  {% set description = "See full details about the selected stock, including daily and historical performance, volume, market cap, moving averages,  today's price change, and much more. You can also check related companies in the same sector." %}
  {% set last_updated = last_updated | format_et_datetime | display %}
  {{ jumbotron(heading, description, last_updated) }}

  <!-- Stock Detail Tabs: Summary / Chart / Overview -->
  <section class="mb-5">
    <!-- Horizontal Nav Tabs -->
    <div class="container">
      <ul class="nav nav-tabs mb-4" id="stockTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active fw-semibold" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab" aria-controls="chart" aria-selected="false">Chart</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="false">Overview</button>
        </li>
      </ul>
    </div>

    <!-- Tab Panes -->
    <div class="tab-content" id="stockTabContent">

      <!-- Summary Tab -->
      <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <!-- Stock Summary Section -->
        <section class="container">
          <!-- Summary Cards: Today's Performance, 200-DMA, Related Companies -->
          <div class="row g-4 mb-4">
            <!-- Today's Performance Summary Card -->
            <div class="col-md-4 order-1 order-md-2">
              <div class="card h-100 shadow-sm text-dark">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-dark pb-1">
                    Today's Performance
                  </h5>

                  <div class="mb-2">
                    <span class="fw-semibold">Day Close:</span>
                    <span>{{ stock.day_close | currency }}</span>
                  </div>

                  <div class="mb-2 fs-3">
                    {{ stock_todays_change(stock) }}
                  </div>

                  <div>
                    <span class="fw-semibold">Volume:</span>
                    <span>{{ stock.volume | int }} ({{ stock.volume | humanize_number(decimals=2) }})</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- DMA-200 Summary Card -->
            <div class="col-md-4 order-2 order-md-1">
              <div class="card h-100 shadow-sm text-dark">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-dark pb-1">200-Day Moving Average {{ dma_200_diff_popover() }}</h5>

                  <div class="mb-2">
                    <span class="fw-semibold">200-DMA:</span>
                    <span>{{ stock.dma_200 | currency }}</span>
                  </div>

                  <div class="fs-5 mt-3">
                    <span class="fw-semibold py-1 px-4 border border-dark" style="background-color: {{ stock.dma_200_perc_diff | dma_200_perc_diff_color }};">{{ stock.dma_200_perc_diff | percent }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Related Companies Card -->
            <div class="col-md-4 order-3 order-md-3">
              <div class="card h-100 shadow-sm text-dark">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-dark pb-1">Related Companies</h5>

                  {% if rel_companies %}
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                      {% for ticker in rel_companies %}
                        <a href="{{ url_for('show_stock', ticker=ticker) }}" class="fw-semibold text-primary">
                          {{ ticker }}
                        </a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="semibold text-muted">N/A</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Charts Row -->
          <div class="row g-3">
            <!-- OHLC Chart -->
            <div class="col-lg-4 col-md-12 order-lg-2 order-1">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">Day Price Range</h5>
                  <div class="summary-chart-container">
                    <canvas id="ohlc-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- DMA Comparison Chart -->
            <div class="col-lg-4 col-md-6 order-lg-1 order-2">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">DMA Comparison vs Close</h5>
                  <div class="summary-chart-container">
                    <canvas id="dma-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- 52-Week Range Chart -->
            <div class="col-lg-4 col-md-6 order-lg-3 order-3">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">52-Week Range vs Close</h5>
                  <div class="summary-chart-container">
                    <canvas id="range-52w-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Chart Tab -->
      <div class="tab-pane fade" id="chart" role="tabpanel" aria-labelledby="chart-tab">
        <!-- Stock Chart Section -->
        <section class="container py-2 border border-2 border-dark">
          <!-- Top Controls: Timeframe Selector + % Change + Tooltip Toggle + Custom Chart Legend -->
          <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
            <!-- Timeframe buttons -->
            <div id="tf-btn-toolbar"
                 class="btn-toolbar d-flex flex-nowrap overflow-auto"
                 role="toolbar"
                 aria-label="Stock chart time frame selector">
              <div class="btn-group" role="group" aria-label="Timeframe options">
                {% for timeframe in timeframe_options %}
                  <button
                    type="button"
                    class="tf-btn btn btn-outline-secondary mx-0"
                    data-timeframe="{{ timeframe }}"
                    aria-label="{{ timeframe }}">
                    {{ timeframe }}
                  </button>
                {% endfor %}
              </div>
            </div>

            <!-- Percentage change -->
            <span id="tf-change-perc" class="py-1 px-2 fw-semibold text-white border border-dark rounded-0" aria-label="Timeframe percentage change">
              <!-- Populated by JS -->
            </span>

            <!-- Tooltip toggle -->
            <div class="form-check form-switch">
              <input class="form-check-input cursor-pointer" type="checkbox" role="switch" id="tooltip-toggle">
              <label class="form-check-label" for="tooltip-toggle">Tooltips</label>
            </div>

            <!-- Custom chart legend -->
            <div id="chart-legend-container" class="ms-auto">
              <ul id="chart-legend" class="list-unstyled d-flex mb-0 align-items-center gap-3">
                <!-- Custom chart legend items inserted by plugin -->
              </ul>
            </div>
          </div>

          <!-- Stock Chart -->
          <div id="stock-chart-container" class="position-relative">
            <!-- Chart Canvas -->
            <canvas id="stock-chart" data-ticker="{{ stock.ticker }}"></canvas>
            <!-- Chart Loading Spinner Overlay -->
            {{ loading_spinner("stock-chart-loading-spinner", "Chart Loading...", "absolute") }}
            <!-- Missing Data Overlay -->
            <div id="stock-chart-missing-data"
                 class="d-none d-flex flex-column justify-content-center align-items-center position-absolute top-0 start-0 w-100 h-100 bg-white">
                <p class="text-muted fs-5">No chart data available</p>
            </div>
          </div>

          <!-- Hover Info Section Below Chart -->
          <div id="hover-info" class="container-fluid mt-2">
              <div class="row text-center border-top border-dark py-2">
                  <div id="date-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="close-price-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-30-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-50-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-200-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="volume-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
              </div>
          </div>
        </section>
      </div>

      <!-- Overview Tab -->
      <div class="tab-pane fade" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <!-- Stock Overview Section -->
        <section class="container">
          <div class="row">
            <!-- Company Description -->
            <div class="col-lg-4 mb-4 text-center border py-1">
              <span class="fs-4 fw-semibold">{{ stock.name | display }}</span>
              <p class="mt-1">{{ stock.description | display }}</p>
            </div>

            <!-- Data Table -->
            <div class="col-lg-8">
              <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                  <tbody>
                    <tr><th>Ticker Symbol</th><td>{{ stock.ticker | display }}</td></tr>
                    <tr><th>Company Name</th><td>{{ stock.name | display }}</td></tr>
                    <tr>
                      <th>Homepage</th>
                      <td>
                        {% if stock.homepage_url %}
                          <a href="{{ stock.homepage_url }}" target="_blank" class="fw-semibold text-primary">
                            {{ stock.homepage_url }}
                          </a>
                        {% else %}
                          <span>N/A</span>
                        {% endif %}
                      </td>
                    </tr>
                    <tr><th>Industry</th><td>{{ stock.industry | display }}</td></tr>
                    <tr><th>List Date</th><td>{{ stock.list_date | display }}</td></tr>
                    <tr><th>Type</th><td>{{ stock.type | display }}</td></tr>
                    <tr><th>Total Employees</th><td>{{ stock.total_employees | int }}</td></tr>
                    <tr>
                      <th>Market Cap</th>
                      <td>
                        {{ stock.market_cap | currency }}
                        ({{ stock.market_cap | humanize_number(decimals=3) }})
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

    </div>
  </section>

{% else %}
  <!-- Error Section -->
  <div class="pt-5 mt-5 text-center">
    <h1 class="display-4">Stock Not Found</h1>
    <p class="lead">The requested stock does not exist in our database.</p>
    <a href="{{ url_for('home') }}" class="btn btn-primary mt-3">Go Back Home</a>
  </div>

{% endif %}
{% endblock %}

{% block script %}
  <script>
    // Passing the stock data to JS script
    const stockData = {{ stock | tojson }}

    // Initial stock chart to show on page load
    const initialStockChartData = {{ initial_stock_chart_data | tojson }};
    const initialTimeframe = "{{ initial_timeframe }}";

    // Passing the stock change colors to the JS script,
    // using jinja filter on dummy values (1,-1)
    const POSITIVE_COLOR = "{{ 1 | stock_change_color }}";
    const NEGATIVE_COLOR = "{{ -1 | stock_change_color }}";

    // Globally defined colors for stock summary and chart
    const CLOSE_PRICE_COLOR = "rgba(54, 220, 235, 1)";
    const EMA_30_COLOR = "rgba(0, 251, 25, 1)";
    const EMA_50_COLOR = "rgba(251, 188, 0, 1)";
    const EMA_200_COLOR = "rgba(255, 0, 0, 1)";

    // Globally defined constants for stock summary and chart
    const DECIMAL_PRECISION = 2;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js" defer></script>

  <script src="{{ url_for('static', filename='js/stock_summary.js') }}" type="text/javascript" defer></script>
  <script src="{{ url_for('static', filename='js/stock_chart.js') }}" type="text/javascript" defer></script>
{% endblock %}