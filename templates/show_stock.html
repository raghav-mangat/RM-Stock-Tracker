{% from "macros/popovers.html" import dma_200_diff_popover %}
{% from "macros/jumbotron.html" import jumbotron %}
{% from "macros/stock_attributes.html" import stock_todays_change, stock_dma_200_perc_diff %}
{% from "macros/arrow_direction.html" import arrow_direction %}

{% extends "base.html" %}

{% block title %}
  {{ stock.ticker | display }} - {{ stock.name | display }} | RM Stock Tracker
{% endblock %}

{% block style %}
  <link href="{{ url_for('static', filename='styles/stock_chart.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
{% if stock.ticker %}
  <!-- Hero Section -->
  {% set heading = stock.ticker ~ " - " ~ (stock.name | display) %}
  {% set description = "See full details about the selected stock, including daily and historical performance, volume, market cap, moving averages,  today's price change, and much more. You can also check related companies in the same sector." %}
  {% set last_updated = last_updated | format_et_datetime | display %}
  {{ jumbotron(heading, description, last_updated) }}

  <!-- Stock Detail Tabs: Summary / Chart / Overview -->
  <section class="mb-5">
    <!-- Horizontal Nav Tabs -->
    <div class="container">
      <ul class="nav nav-tabs mb-4" id="stockTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active fw-semibold" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab" aria-controls="chart" aria-selected="false">Chart</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link fw-semibold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="false">Overview</button>
        </li>
      </ul>
    </div>

    <!-- Tab Panes -->
    <div class="tab-content" id="stockTabContent">

      <!-- Summary Tab -->
      <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <!-- Stock Summary Section -->
        <section class="container">
          <!-- Summary Cards: Performance, 200-DMA, Related Companies -->
          <div class="row g-4 mb-4">
            <!-- Performance Summary Card -->
            <div class="col-md-4">
              <div class="card h-100 shadow-sm text-white" style="background-color: {{ stock.todays_change | stock_change_color }};">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-white pb-1">
                    Performance
                  </h5>

                  <div class="mb-2">
                    <span class="fw-semibold">Day Close:</span>
                    <span class="fw-bold">{{ stock.day_close | currency }}</span>
                  </div>

                  <div class="mb-2">
                    <span class="fw-semibold">Today's Change:</span>
                    {% if (stock.todays_change is not none) and (stock.todays_change_perc is not none) %}
                        <span class="fw-bold">
                            {{ arrow_direction(stock.todays_change) }}
                            {{ stock.todays_change_perc | abs | percent }} ({{ stock.todays_change | abs | float }})
                        </span>
                    {% else %}
                        <span class="fw-bold">N/A</span>
                    {% endif %}
                  </div>

                  <div>
                    <span class="fw-semibold">Volume:</span>
                    <span class="fw-bold">{{ stock.volume | int }} ({{ stock.volume | humanize_number(decimals=2) }})</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- DMA-200 Summary Card -->
            <div class="col-md-4">
              <div class="card h-100 shadow-sm text-dark" style="background-color: {{ stock.dma_200_perc_diff | dma_200_perc_diff_color }};">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-dark pb-1">200-Day Moving Average {{ dma_200_diff_popover() }}</h5>

                  <div class="mb-2">
                    <span class="fw-semibold">200 DMA:</span>
                    <span class="fw-bold">{{ stock.dma_200 | currency }}</span>
                  </div>

                  <div>
                    <span class="fw-semibold">200 DMA % Diff:</span>
                    <span class="fw-bold">{{ stock.dma_200_perc_diff | percent }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Related Companies Card -->
            <div class="col-md-4">
              <div class="card h-100 shadow-sm text-dark bg-light">
                <div class="card-body text-center">
                  <h5 class="card-title border-bottom border-dark pb-1">Related Companies</h5>

                  {% if rel_companies %}
                    <div class="d-flex flex-wrap gap-2">
                      {% for ticker in rel_companies %}
                        <a href="{{ url_for('show_stock', ticker=ticker) }}" class="fw-semibold text-primary">
                          {{ ticker }}
                        </a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span>N/A</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Charts Row -->
          <div class="row g-3">
            <!-- OHLC Chart -->
            <div class="col-lg-4 col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">Day Price Range</h5>
                  <canvas id="ohlcChart" height="150"></canvas>
                </div>
              </div>
            </div>

            <!-- 52-Week Range Chart -->
            <div class="col-lg-4 col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">52-Week Range vs Close</h5>
                  <canvas id="range52wChart" height="150"></canvas>
                </div>
              </div>
            </div>

            <!-- DMA Comparison Chart -->
            <div class="col-lg-4 col-md-12">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">DMA Comparison vs Close</h5>
                  <canvas id="dmaChart" height="150"></canvas>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Chart Tab -->
      <div class="tab-pane fade" id="chart" role="tabpanel" aria-labelledby="chart-tab">
        <!-- Stock Chart Section -->
        <section class="container py-2 border border-dark">
          <!-- Top Controls: Timeframe Selector + % Change + Tooltip Toggle + Custom Chart Legend -->
          <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
            <!-- Timeframe buttons -->
            <div id="tf-btn-toolbar" class="btn-toolbar d-flex flex-nowrap overflow-auto" role="toolbar" aria-label="Chart time frame selector">
              <div class="btn-group" role="group" aria-label="Timeframe options">
                {% for timeframe in timeframe_options %}
                  <button type="button" class="tf-btn btn btn-outline-secondary"
                          data-timeframe="{{ timeframe }}">
                      {{ timeframe }}
                  </button>
                {% endfor %}
              </div>
            </div>

            <!-- Percentage change -->
            <span id="tf-change-perc" class="btn fw-semibold text-white border border-dark rounded-0" aria-label="Timeframe percentage change">
              <!-- Populated by JS -->
            </span>

            <!-- Tooltip toggle -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="tooltip-toggle">
              <label class="form-check-label" for="tooltip-toggle">Tooltips</label>
            </div>

            <!-- Custom chart legend -->
            <div id="chart-legend-container" class="ms-auto">
              <ul id="chart-legend" class="list-unstyled d-flex mb-0 align-items-center gap-3">
                <!-- Custom chart legend items inserted by plugin -->
              </ul>
            </div>
          </div>

          <!-- Chart Section -->
          <div id="chart-container" class="position-relative">
              <canvas id="stock-chart" data-ticker="{{ stock.ticker }}"></canvas>
              <!-- Chart Loading Spinner Overlay -->
              {{ loading_spinner("chart-loading-spinner", "Chart Loading...", "absolute") }}
          </div>

          <!-- Hover Info Section Below Chart -->
          <div id="hover-info" class="container-fluid mt-2">
              <div class="row text-center border border-secondary rounded py-2">
                  <div id="date-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="close-price-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-30-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-50-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="ema-200-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
                  <div id="volume-value" class="col-6 col-sm-4 col-md-2 fw-semibold d-flex align-items-center"></div>
              </div>
          </div>
        </section>
      </div>

      <!-- Overview Tab -->
      <div class="tab-pane fade" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <!-- Stock Overview Section -->
        <section class="container">
          <div class="row">
            <!-- Company Description -->
            <div class="col-lg-4 mb-4 text-center">
              <span class="fs-4 fw-semibold">{{ stock.name | display }}</span>
              <p class="text-muted mt-1">{{ stock.description | display }}</p>
            </div>

            <!-- Data Table -->
            <div class="col-lg-8">
              <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                  <tbody>
                    <tr><th>Ticker Symbol</th><td>{{ stock.ticker | display }}</td></tr>
                    <tr><th>Company Name</th><td>{{ stock.name | display }}</td></tr>
                    <tr>
                      <th>Homepage</th>
                      <td>
                        {% if stock.homepage_url %}
                          <a href="{{ stock.homepage_url }}" target="_blank" class="fw-semibold text-primary">
                            {{ stock.homepage_url }}
                          </a>
                        {% else %}
                          <span>N/A</span>
                        {% endif %}
                      </td>
                    </tr>
                    <tr><th>Industry</th><td>{{ stock.industry | display }}</td></tr>
                    <tr><th>List Date</th><td>{{ stock.list_date | display }}</td></tr>
                    <tr><th>Type</th><td>{{ stock.type | display }}</td></tr>
                    <tr><th>Total Employees</th><td>{{ stock.total_employees | int }}</td></tr>
                    <tr>
                      <th>Market Cap</th>
                      <td>
                        {{ stock.market_cap | currency }}
                        {% if stock.market_cap is not none and stock.market_cap >= 1000 %}
                          ({{ stock.market_cap | humanize_number(decimals=2) }})
                        {% endif %}
                      </td>
                    </tr>
                    <tr><th>Day Open</th><td>{{ stock.day_open | currency }}</td></tr>
                    <tr><th>Day High</th><td>{{ stock.day_high | currency }}</td></tr>
                    <tr><th>Day Low</th><td>{{ stock.day_low | currency }}</td></tr>
                    <tr><th>Day Close</th><td class="fw-semibold bg-info-subtle">{{ stock.day_close | currency }}</td></tr>
                    <tr>
                      <th>Volume</th>
                      <td>
                        {{ stock.volume | int }}
                        {% if stock.volume is not none and stock.volume >= 1000 %}
                            ({{ stock.volume | humanize_number(decimals=2) }})
                        {% endif %}
                      </td>
                    </tr>
                    <tr>
                      <th>Today's Change</th>
                      <td>
                        {{ stock_todays_change(stock) }}
                      </td>
                    </tr>
                    <tr><th>200 DMA</th><td>{{ stock.dma_200 | currency }}</td></tr>
                    <tr>
                      <th>200 DMA % Diff {{ dma_200_diff_popover() }}</th>
                      {{ stock_dma_200_perc_diff(stock) }}
                    </tr>
                    <tr><th>50 DMA</th><td>{{ stock.dma_50 | currency }}</td></tr>
                    <tr><th>52W High</th><td>{{ stock.high_52w | currency }}</td></tr>
                    <tr><th>52W Low</th><td>{{ stock.low_52w | currency }}</td></tr>
                    <tr>
                      <th>Related Companies</th>
                      <td>
                        {% if rel_companies %}
                          {% for ticker in rel_companies %}
                            <a href="{{ url_for('show_stock', ticker=ticker) }}" class="fw-semibold text-primary">
                              {{ ticker }}
                            </a>{% if not loop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          <span>N/A</span>
                        {% endif %}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

    </div>
  </section>

{% else %}
  <!-- Error Section -->
  <div class="pt-5 mt-5 text-center">
    <h1 class="display-4">Stock Not Found</h1>
    <p class="lead">The requested stock does not exist in our database.</p>
    <a href="{{ url_for('home') }}" class="btn btn-primary mt-3">Go Back Home</a>
  </div>

{% endif %}
{% endblock %}

{% block script %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <script>
    // Passing the stock data to JS script
    const stockData = {{ stock | tojson }}

    // Initial chart to show on page load
    const initialChartData = {{ initial_chart_data | tojson }};
    const initialTimeframe = "{{ initial_timeframe }}";

    // Passing the stock change colors to the JS script to color
    // the timeframe tooltips, using jinja filter on dummy values (1,-1)
    const positiveColor = "{{ 1 | stock_change_color }}";
    const negativeColor = "{{ -1 | stock_change_color }}";
  </script>

  <script src="{{ url_for('static', filename='js/stock_summary.js') }}" type="text/javascript"></script>
  <script src="{{ url_for('static', filename='js/stock_chart.js') }}" type="text/javascript"></script>
{% endblock %}